# 1/26

생성일: 2026년 1월 26일 오전 11:04

### update

`@Transatinal` → 받아온 것들을 영속성 컨텍스트 관리해주는 것 → 더티체킹을 해줌 → 바뀐 것을 인지하고 알아서 업데이트문 쏴줌 (붙이면 영속성 컨텍스트 관리 대상이 되는 것)

- 더티체킹?
1. dto 만들어주고
    
    ```java
    package com.example.demo.dto.request;
    
    import lombok.Getter;
    import lombok.RequiredArgsConstructor;
    
    @Getter
    @RequiredArgsConstructor
    public class UserUpdateDto {
    
    	private final Long userId;
    	private final String phoneNumber;
    	private final String email;
    }
    ```
    
2. 사용할 repository 작성
    
    ```java
    @Repository
    public interface UserRepository extends JpaRepository<User, Long> {
    
    	Optional<User> findUserByPhoneNumber(String phoneNumber);
    
    	User findUserById(Long id);
    }
    ```
    
3. 서비스 코드
    
    ```java
    public Long updateUser(UserUpdateDto userUpdateDto) {
    		User user = userRepository.findUserById(userUpdateDto.getUserId());
    		user.updateUser(userUpdateDto);
    
    		return user.getId();
    	}
    ```
    
4. 컨트롤러
    
    ```java
    @PutMapping("")
    	public ResponseEntity<Long> updateUser(@RequestBody UserUpdateDto dto){
    
    		return ResponseEntity.ok(userService.updateUser(dto));
    	}
    ```
    

### `@DynamicUpdate` : 바뀐 필드만 바꿔줌

```java
Hibernate: 
    update
        users 
    set
        email=?,
        name=?,
        phone_number=?,
        sex=? 
    where
        id=?

```

원래 이랬는데(몇 개만 수정해도 전부 바꿈)

```java
Hibernate: 
    update
        users 
    set
        phone_number=? 
    where
        id=?

```

user 엔티티에 `@DynamicUpdate` 어노테이션 붙이고 나서는 이렇게 뜸(수정된 내용만 변경) 

---

### 1:N 관계

Diary entity 작성 → ManyToOne (외래키가 필요한 엔티티)

유저에 추가 (안해도 됨)

```java
@OneToMany(mappedBy = "user")
	private final List<Diary> diaries = new ArrayList<>();
```

- 리스트 초기화 필요

---

### put 메소드 - list로 반환

`@RequestParam` vs `@PathVariable`

- RequestParam은 부가적인 것(없어도 상관 x..) ex 페이지 등등..
- PathVariable : 페이지(반환)을 좌우! 없으면 영향을 줌(아예 다른 페이지가 되거나 에러를 뱉음)
- dto 사용
    
    ```java
    public Map<String, List<Diary>> getDiaryList(Long userId){
    		User user = userRepository.findUserById(userId);
    
    		Map<String, List<Diary>> result = new HashMap<>();
    
    		result.put("Diary List", user.getDiaries());
    
    		return result;
    	}
    ```
    
    → dto를 사용 안하고 Diary 객체로 바로 반환하게 되면 계속해서 순환(diary-user 간의), 따라서 dto 사용
    

---

### 단건조회

repository

findById → 기본 함수 → Optional 반환, OrElseThrow… 사용

선언 함수 findDiaryById 

`FetchType.LAZY`  설정 안하면 fk 돼있는거 다 가져옴 (어노테이션)

```java
Hibernate: 
    select
        d1_0.id,
        d1_0.content,
        d1_0.created_at,
        d1_0.user_id 
    from
        diary d1_0 
    where
        d1_0.id=?
Hibernate: 
    select
        u1_0.id,
        u1_0.birthday,
        u1_0.email,
        u1_0.name,
        u1_0.phone_number,
        u1_0.sex 
    from
        users u1_0 
    where
        u1_0.id=?
```

→ diary만 검색한건데 user 쿼리까지 날라감

`@ManyToOne(fetch = FetchType.LAZY)` 어노테이션 추가하면

```java
Hibernate: 
    select
        d1_0.id,
        d1_0.content,
        d1_0.created_at,
        d1_0.user_id 
    from
        diary d1_0 
    where
        d1_0.id=?

```

쿼리 한 번만 날라감

(참고)

```java
	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "user_id", nullable = false)
	private User user;
```

---

Diary

```java
@Entity
@Table(name = "diary")
@Getter
@NoArgsConstructor
public class Diary {

	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Long id;

	@ManyToOne(fetch = FetchType.LAZY)
	@JoinColumn(name = "user_id", nullable = false)
	private User user;

	@Column(name = "content")
	@Lob
	private String content;

	@Column(name = "created_at")
	private LocalDate createdAt;

	@Builder
	public Diary(User user, String content, LocalDate createdAt) {
		this.user = user;
		this.content = content;
		this.createdAt = createdAt;
	}
}
```

```java
@Repository
public interface DiaryRepository extends JpaRepository<Diary, Long> {

	Diary findDiaryById(Long id);
}
```

```java
@Service
@Transactional
@RequiredArgsConstructor
public class DiaryService {

	private final DiaryRepository diaryRepository;
	private final UserRepository userRepository;

	public boolean createDiary(DiaryDto dto){
		User user = userRepository.findUserById(dto.getUserId());

		Diary newDiary = Diary.builder()
			.user(user)
			.content(dto.getContent())
			.createdAt(dto.getCreatedAt())
			.build();

		diaryRepository.save(newDiary);

		user.addDiary(newDiary);

		return true;
	}

	public Map<String, List<DiaryResponseDto>> getDiaryList(Long userId){
		User user = userRepository.findUserById(userId);

		// dto list 생성
		List<DiaryResponseDto> dtoList = new ArrayList<>();

		//diary -> dto 변환
		for(Diary diary : user.getDiaries()){
			DiaryResponseDto dto = DiaryResponseDto.builder()
				.diaryId(diary.getId())
				.content(diary.getContent())
				.createdAt(diary.getCreatedAt())
				.build();

			dtoList.add(dto);
		}

		Map<String, List<DiaryResponseDto>> result = new HashMap<>();

		result.put("Diary List", dtoList);

		return result;
	}

	public DiaryResponseDto getDiary(Long diaryId){
		Diary diary = diaryRepository.findDiaryById(diaryId);

		return DiaryResponseDto.builder()
			.content(diary.getContent())
			.createdAt(diary.getCreatedAt())
			.build();
	}

	// public Map<String, List<Diary>> getDiaryList(Long userId){
	// 	User user = userRepository.findUserById(userId);
	//
	// 	Map<String, List<Diary>> result = new HashMap<>();
	//
	// 	result.put("Diary List", user.getDiaries());
	//
	// 	return result;
	// }
}
```

```java
@Controller
@RequestMapping("/diary")
@RequiredArgsConstructor
public class DiaryController {

	private final DiaryService diaryService;

	@PostMapping
	public ResponseEntity<?> createDiary(@RequestBody DiaryDto dto){
		return ResponseEntity.ok(diaryService.createDiary(dto));
	}

	@GetMapping("/{userId}/diaries")
	public ResponseEntity<?> getDiaryList(@PathVariable Long userId){
		return ResponseEntity.ok(diaryService.getDiaryList(userId));
	}

	@GetMapping("/{diaryId}/diary")
	public ResponseEntity<?> getDiary(@PathVariable Long diaryId){
		return ResponseEntity.ok(diaryService.getDiary(diaryId));
	}
}

```